
# 推动箱子

在上一章中，我们让玩家可以移动，但他可以穿过墙壁和箱子，并没有真正与环境交互。在本节中，我们将为玩家的移动添加一些更智能的逻辑。

## 移动组件

首先，我们需要让代码稍微更通用一些。如果你还记得上一章，我们是通过操作玩家来决定如何移动他们的，但我们也需要移动箱子。此外，将来我们可能会引入其他可移动类型的对象，因此我们需要考虑到这一点。按照真正的 ECS 精神，我们将使用标记组件来区分哪些实体是可移动的，哪些不是。例如，玩家和箱子是可移动的，而墙是不可移动的。箱子放置点在这里无关紧要，因为它们不会移动，但它们也不应该影响玩家或箱子的移动，因此箱子放置点不会具有这些组件中的任何一个。

以下是我们的两个新组件：

```rust
{{#include ../../../code/rust-sokoban-c02-03/src/main.rs:components_movement}}
```

接下来，我们将：

* 为玩家和箱子添加 `with(Movable)`
* 为墙添加 `with(Immovable)`
* 对地板和箱子放置点不做任何操作（如前所述，它们不应成为我们的移动/碰撞系统的一部分，因为它们对移动没有影响）

```rust
{{#include ../../../code/rust-sokoban-c02-03/src/main.rs:entities}}
```

## 移动需求

现在让我们思考一些示例来说明移动的需求。这将帮助我们理解如何修改输入系统的实现以正确使用 `Movable` 和 `Immovable`。

场景：

1. `(player, floor)` 并按下 `RIGHT` -> 玩家应该向右移动
2. `(player, wall)` 并按下 `RIGHT` -> 玩家不应向右移动
3. `(player, box, floor)` 并按下 `RIGHT` -> 玩家应该向右移动，箱子也应该向右移动
4. `(player, box, wall)` 并按下 `RIGHT` -> 没有任何东西应该移动
5. `(player, box, box, floor)` 并按下 `RIGHT` -> 玩家、箱子1 和箱子2 应该都向右移动一格
6. `(player, box, box, wall)` 并按下 `RIGHT` -> 没有任何东西应该移动

基于这些场景，我们可以做出以下观察：

* 碰撞/移动检测应该一次性处理所有涉及的对象——例如，对于场景 6，如果我们逐个处理，每次处理一个对象，我们会先移动玩家，再移动第一个箱子，当我们处理第二个箱子时发现无法移动，此时需要回滚所有的移动操作，这是不可行的。因此，对于每个输入，我们必须找出所有涉及的对象，并整体判断该动作是否可行。
* 一条包含空位的可移动链可以移动（空位在此表示既非可移动也非不可移动的东西）
* 一条包含不可移动位置的可移动链不能移动
* 尽管所有示例都是向右移动，这些规则应该可以推广到任何方向，按键仅仅影响我们如何找到链条

因此，基于这些规则，让我们开始实现这个逻辑。以下是我们需要的逻辑模块的一些初步想法：

1. **找到所有可移动和不可移动的实体** - 这样我们可以判断它们是否受到移动的影响
2. **根据按键确定移动方向** - 我们在上一节已经大致解决了这个问题，基本上是一些基于按键枚举的 +1/-1 操作
3. **遍历从玩家到地图边缘的所有位置**，根据方向确定轴线——例如，如果按下右键，我们需要从 `player.x` 遍历到 `map_width`，如果按下上键，我们需要从 `0` 遍历到 `player.y`
4. **对于序列中的每个格子** 我们需要：
    * 如果格子是可移动的，继续并记住这个格子
    * 如果格子不可移动，停止并不移动任何东西
    * 如果格子既不可移动也不可移动，移动我们记住的所有格子

以下是输入系统的新实现，有点长，但希望能理解。

```rust
{{#include ../../../code/rust-sokoban-c02-03/src/main.rs:input_system}}
```

现在运行代码，你会发现它真的有效了！我们不能再穿过墙壁，可以推动箱子，当箱子碰到墙时会停下。

![移动玩家](./images/movement.gif)

以下是完整代码。

```rust
{{#include ../../../code/rust-sokoban-c02-03/src/main.rs}}
```

> **_CODELINK:_**  你可以在 [这里](https://github.com/iolivia/rust-sokoban/tree/master/code/rust-sokoban-c02-03) 查看本示例的完整代码。
